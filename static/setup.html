<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EtherPi • Setup</title>
  <style>
    :root { color-scheme: light dark;
      --bg:#0b0f14; --card:#111821; --text:#e6edf3; --muted:#9fb2c3; --line:#1f2a36; --btn:#182433;
    }
    body{font-family:system-ui,sans-serif;margin:20px;max-width:980px;background:var(--bg);color:var(--text)}
    a.btn,button.btn{
      padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:var(--btn);
      color:var(--text);text-decoration:none;cursor:pointer;display:inline-flex;align-items:center;
      justify-content:center;min-height:36px;line-height:1;font:inherit
    }
    .logo{font-weight:800;font-size:26px;letter-spacing:.5px;background:linear-gradient(90deg,#ff5f6d,#ffc371,#47cf73,#2ea8ff,#bd34fe);
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px 16px;background:var(--card)}
    .muted{color:var(--muted)}
    .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    label{display:flex;flex-direction:column;gap:6px;font-size:.95rem}
    input,select{padding:8px 10px;background:#0a0f14;color:var(--text);border:1px solid var(--line);border-radius:8px;width:100%;box-sizing:border-box;height:36px}
    input[type="color"]{padding:0;width:64px;height:36px;border-radius:8px;background:#0a0f14;appearance:none}
    input[type="color"]::-webkit-color-swatch-wrapper{padding:4px}
    input[type="color"]::-webkit-color-swatch{border:none;border-radius:6px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  </style>
</head>
<body>
  <div class="top">
    <div class="logo">EtherPi • Setup</div>
    <div class="row">
      <a class="btn" href="/">Back</a>
      <button class="btn" onclick="save()">Save</button>
      <button class="btn" onclick="reloadSvc()">Reload Program</button>
    </div>
  </div>
  <p class="muted">Network, LEDs (RGB & RGBW), link colors, sync & service info.</p>

  <div class="cards">

    <!-- SWITCH -->
    <div class="card">
      <h3>Switch</h3>
      <div class="grid2">
        <label>IP / Host <input id="sw_host" placeholder="192.168.1.100"></label>
        <label>SNMP Version
          <select id="snmp_ver">
            <option value="v2c">v2c</option>
          </select>
        </label>
        <label>Community <input id="snmp_comm" placeholder="public"></label>
      </div>
      <div class="row">
        <button class="btn" onclick="detectSwitch()">Detect switch</button>
      </div>
      <div class="muted" id="sw_detect_hint" style="margin-top:6px"></div>
    </div>

    <!-- NETWORK -->
    <div class="card">
      <h3>Network</h3>
      <div class="grid2">
        <label>Mode
          <select id="net_mode" onchange="toggleStatic()">
            <option value="dhcp">DHCP</option>
            <option value="static">Static</option>
          </select>
        </label>
        <label>IP (CIDR) <input id="net_ip" placeholder="192.168.1.152/24"></label>
        <label>Gateway <input id="net_gw" placeholder="192.168.1.1"></label>
        <label>DNS (comma) <input id="net_dns" placeholder="1.1.1.1,8.8.8.8"></label>
      </div>
      <div class="row"><button class="btn" onclick="applyNet()">Apply Network</button></div>
    </div>

    <!-- LEDS -->
    <div class="card">
      <h3>LEDs</h3>
      <div class="grid2">
        <label>Type
          <select id="led_type" onchange="fillColorOrders()">
            <option value="ws2812b">WS2812B (RGB)</option>
            <option value="ws2812">WS2812 (RGB)</option>
            <option value="ws2811">WS2811 (RGB)</option>
            <option value="sk6812">SK6812 (RGB)</option>
            <option value="sk6812w">SK6812W (RGBW)</option>
          </select>
        </label>
        <label>Color Order
          <select id="led_order"></select>
        </label>
        <label>Brightness <input id="led_bright" type="number" min="1" max="255"></label>
        <label>LEDs per port <input id="leds_per_port" type="number" min="1" max="2"></label>
        <label>GPIO Pin <input id="led_pin" type="number" min="10" max="21" placeholder="18"></label>
      </div>
      <div class="row">
        <small class="muted">Tip: RGBW strips require SK6812W + an RGBW order (e.g., GRBW).</small>
      </div>
    </div>

    <!-- SCREEN -->
    <div class="card">
      <h3>Screen</h3>
      <div class="grid2">
        <label>Enabled
          <select id="disp_enabled">
            <option value="true">On</option>
            <option value="false">Off</option>
          </select>
        </label>
        <label>Model
          <select id="disp_model">
            <option value="auto">Auto</option>
            <option value="st7789_240">ST7789 240×240</option>
            <option value="st7735_160">ST7735 160×128</option>
            <option value="ssd1306_128">SSD1306 128×64</option>
          </select>
        </label>
        <label>Rotation
          <select id="disp_rotation">
            <option value="0">0°</option>
            <option value="90">90°</option>
            <option value="180">180°</option>
            <option value="270">270°</option>
          </select>
        </label>
        <label>Page time (sec)
          <input id="disp_page_sec" type="number" min="1" max="30" placeholder="5">
        </label>
        <label>Slide (ms)
          <input id="disp_slide_ms" type="number" min="0" max="3000" placeholder="400">
        </label>
      </div>
      <div class="row">
        <small class="muted">Controls how long each page is shown and the swipe animation speed. Pinout is fixed.</small>
      </div>
    </div>

    <!-- SYNC -->
    <div class="card">
      <h3>Sync</h3>
      <div class="grid2">
        <label>Mode
          <select id="sync_mode">
            <option value="off">off</option>
            <option value="master">master</option>
            <option value="slave">slave</option>
          </select>
        </label>
        <label>Multicast <input id="sync_mc" placeholder="239.0.0.57"></label>
        <label>Port <input id="sync_port" type="number" min="1024" max="65535"></label>
      </div>
    </div>

    <!-- LINK COLORS -->
    <div class="card">
      <h3>Link LED Colors</h3>
      <div class="grid2">
        <label>Down <input id="lc_down" type="color"></label>
        <label>10 Mbps <input id="lc_10" type="color"></label>
        <label>100 Mbps <input id="lc_100" type="color"></label>
        <label>1 Gbps <input id="lc_1000" type="color"></label>
        <label>2.5 Gbps <input id="lc_2500" type="color"></label>
        <label>10 Gbps <input id="lc_10000" type="color"></label>
      </div>
    </div>

    <!-- SERVICE (merged Build + Device) -->
    <div class="card">
      <h3>Service</h3>
      <div class="grid2">
        <label>Device name
          <input id="dev_name" placeholder="e.g. rack-left">
        </label>
        <div>Version: <span id="ver">loading…</span></div>
        <div>IP: <span id="sys_ip">–</span></div>
        <div>MAC: <span id="sys_mac">–</span></div>
        <div>Update: <span id="upd_status">–</span></div>
        <div>Latest: <span id="upd_latest">–</span></div>
      </div>
      <div class="row">
        <button class="btn" onclick="reloadSvc()">Reload Program</button>
        <button class="btn" id="btn_check_update" onclick="checkUpdate()">Check for updates</button>
        <button class="btn" id="btn_apply_update" onclick="applyUpdateGit()" style="display:none">Update via Git</button>
      </div>
      <div class="row">
        <input id="upd_file" type="file" accept=".zip,.tar,.gz,.tgz">
        <button class="btn" onclick="uploadUpdate()">Upload update</button>
      </div>
      <div class="muted" id="upd_msg" style="margin-top:6px"></div>
    </div>
  </div>

<script>
let CFG = null;

function rgbOrders(){ return ["GRB","RGB","RBG","GBR","BRG","BGR"]; }
function rgbwOrders(){ return ["GRBW","RGBW","RBGW","GBRW","BRGW","BGRW"]; }

function fillColorOrders(){
  const sel = document.getElementById('led_order');
  const typ = document.getElementById('led_type').value || "ws2812b";
  const opts = (typ === "sk6812w") ? rgbwOrders() : rgbOrders();
  const cur = sel.value;
  sel.innerHTML = "";
  for(const o of opts){
    const op = document.createElement('option');
    op.value = o; op.textContent = o;
    sel.appendChild(op);
  }
  if (opts.includes(cur)) sel.value = cur;
}

function toggleStatic(){
  const m = document.getElementById('net_mode').value;
  const dis = (m !== 'static');
  for(const id of ['net_ip','net_gw','net_dns']){
    const el = document.getElementById(id); if(el){ el.disabled = dis; }
  }
}

let updatePoll = null;

function setUpdateUI(state){
  const statusEl = document.getElementById('upd_status');
  const latestEl = document.getElementById('upd_latest');
  const msgEl = document.getElementById('upd_msg');
  const checkBtn = document.getElementById('btn_check_update');
  const applyBtn = document.getElementById('btn_apply_update');
  if(!statusEl || !latestEl){ return; }
  const status = state?.status || 'idle';
  let label = status;
  if(state?.update_available === true){
    label = 'update available';
  }else if(status === 'ok' && state?.latest){
    label = 'up to date';
  }
  statusEl.textContent = label;
  latestEl.textContent = state?.latest || '–';
  if(msgEl){ msgEl.textContent = state?.message || ''; }
  const showUpdate = state?.update_available === true && state?.last_checked;
  if(applyBtn){ applyBtn.style.display = showUpdate ? 'inline-flex' : 'none'; }
  if(checkBtn){ checkBtn.style.display = showUpdate ? 'none' : 'inline-flex'; }
}

async function refreshUpdateStatus(){
  try{
    const r = await fetch('/api/update/status');
    if(!r.ok) return;
    const j = await r.json();
    setUpdateUI(j);
    if(j.status === 'running' || j.status === 'checking') startUpdatePolling();
    else stopUpdatePolling();
  }catch(e){}
}

function startUpdatePolling(){
  if(updatePoll) return;
  updatePoll = setInterval(refreshUpdateStatus, 2000);
}

function stopUpdatePolling(){
  if(updatePoll){
    clearInterval(updatePoll);
    updatePoll = null;
  }
}

async function checkUpdate(){
  const msg = document.getElementById('upd_msg');
  if(msg) msg.textContent = 'Checking for updates...';
  try{
    const r = await fetch('/api/update/check');
    const j = await r.json();
    if(!r.ok && msg){
      msg.textContent = j.error || 'Update check failed.';
    }
  }catch(e){
    if(msg) msg.textContent = 'Update check failed.';
  }
  await refreshUpdateStatus();
}

async function applyUpdateGit(){
  if(!confirm('Update from Git now? The service will restart.')) return;
  const msg = document.getElementById('upd_msg');
  if(msg) msg.textContent = 'Starting update...';
  const r = await fetch('/api/update/pull', {method:'POST'});
  if(!r.ok){
    const j = await r.json().catch(()=>({}));
    if(msg) msg.textContent = j.error || 'Update failed to start.';
    return;
  }
  startUpdatePolling();
}

async function uploadUpdate(){
  const file = document.getElementById('upd_file')?.files?.[0];
  if(!file){ alert('Select a release .zip or .tar.gz first.'); return; }
  const fd = new FormData();
  fd.append('file', file);
  const msg = document.getElementById('upd_msg');
  if(msg) msg.textContent = 'Uploading update...';
  const r = await fetch('/api/update/upload', {method:'POST', body: fd});
  if(!r.ok){
    const j = await r.json().catch(()=>({}));
    if(msg) msg.textContent = j.error || 'Upload failed.';
    return;
  }
  startUpdatePolling();
}

async function load(){
  const r = await fetch('/api/config'); CFG = await r.json();
  document.getElementById('ver').textContent = (await (await fetch('/api/version')).json()).version || 'dev';

  // Device name
  document.getElementById('dev_name').value = (CFG.device?.name) || '';

  // IP / MAC from sysinfo
  try{
    const sys = await (await fetch('/api/sysinfo')).json();
    document.getElementById('sys_ip').textContent  = sys.ip  || '–';
    document.getElementById('sys_mac').textContent = sys.mac || '–';
  }catch(e){}

  // Switch
  document.getElementById('sw_host').value = (CFG.device?.switch_host) || '';
  document.getElementById('snmp_ver').value = (CFG.device?.snmp?.version) || 'v2c';
  document.getElementById('snmp_comm').value = (CFG.device?.snmp?.community) || 'public';

  // LEDs
  document.getElementById('led_type').value   = (CFG.led?.type) || 'ws2812b';
  fillColorOrders();
  document.getElementById('led_order').value  = (CFG.led?.color_order) || ((CFG.led?.type)==='sk6812w' ? 'GRBW' : 'GRB');
  document.getElementById('led_bright').value = CFG.led?.brightness ?? 64;
  document.getElementById('leds_per_port').value = CFG.device?.leds_per_port ?? 2;
  document.getElementById('led_pin').value = CFG.led?.pin ?? 18;

  // Screen
  document.getElementById('disp_enabled').value  = (CFG.display?.enabled ? 'true' : 'false');
  document.getElementById('disp_model').value    = CFG.display?.model ?? 'auto';
  document.getElementById('disp_rotation').value = String(CFG.display?.rotation ?? 0);
  document.getElementById('disp_page_sec').value = CFG.display?.page_sec ?? 5;
  document.getElementById('disp_slide_ms').value = CFG.display?.slide_ms ?? 400;

  // Sync
  document.getElementById('sync_mode').value = CFG.sync?.mode || 'off';
  document.getElementById('sync_mc').value   = CFG.sync?.multicast || '239.0.0.57';
  document.getElementById('sync_port').value = CFG.sync?.port || 49692;

  // Link colors
  const lc = CFG.link_colors || {};
  document.getElementById('lc_down').value   = lc.down   || '#000000';
  document.getElementById('lc_10').value     = lc['10']  || '#A0A0A0';
  document.getElementById('lc_100').value    = lc['100'] || '#FFA500';
  document.getElementById('lc_1000').value   = lc['1000']|| '#00C853';
  document.getElementById('lc_2500').value   = lc['2500']|| '#00FFFF';
  document.getElementById('lc_10000').value  = lc['10000']|| '#2979FF';

  toggleStatic();
  await refreshUpdateStatus();
}

async function save(){
  // Device name
  CFG.device = CFG.device || {};
  // Switch
  CFG.device.switch_host = document.getElementById('sw_host').value || '';
  CFG.device.snmp = CFG.device.snmp || {};
  CFG.device.snmp.version = document.getElementById('snmp_ver').value || 'v2c';
  CFG.device.snmp.community = document.getElementById('snmp_comm').value || 'public';
  CFG.device.name = document.getElementById('dev_name').value.trim();

  // Switch
  document.getElementById('sw_host').value = (CFG.device?.switch_host) || '';
  document.getElementById('snmp_ver').value = (CFG.device?.snmp?.version) || 'v2c';
  document.getElementById('snmp_comm').value = (CFG.device?.snmp?.community) || 'public';

  // LEDs
  CFG.led = CFG.led || {};
  CFG.led.type = document.getElementById('led_type').value || 'ws2812b';
  CFG.led.color_order = document.getElementById('led_order').value || ((CFG.led.type==='sk6812w')?'GRBW':'GRB');
  CFG.led.brightness = parseInt(document.getElementById('led_bright').value||'64',10);
  CFG.led.pin = parseInt(document.getElementById('led_pin').value||'18',10);
  CFG.device.leds_per_port = parseInt(document.getElementById('leds_per_port').value||'2',10);

  // Screen
  CFG.display = CFG.display || {};
  CFG.display.enabled  = (document.getElementById('disp_enabled').value === 'true');
  CFG.display.model    = document.getElementById('disp_model').value || 'auto';
  CFG.display.rotation = parseInt(document.getElementById('disp_rotation').value||'0',10);
  CFG.display.page_sec = parseInt(document.getElementById('disp_page_sec').value||'5',10);
  CFG.display.slide_ms = parseInt(document.getElementById('disp_slide_ms').value||'400',10);

  // Sync
  CFG.sync = CFG.sync || {};
  CFG.sync.mode = document.getElementById('sync_mode').value || 'off';
  CFG.sync.multicast = document.getElementById('sync_mc').value || '239.0.0.57';
  CFG.sync.port = parseInt(document.getElementById('sync_port').value||'49692',10);

  // Link colors
  CFG.link_colors = CFG.link_colors || {};
  CFG.link_colors.down    = document.getElementById('lc_down').value;
  CFG.link_colors['10']   = document.getElementById('lc_10').value;
  CFG.link_colors['100']  = document.getElementById('lc_100').value;
  CFG.link_colors['1000'] = document.getElementById('lc_1000').value;
  CFG.link_colors['2500'] = document.getElementById('lc_2500').value;
  CFG.link_colors['10000']= document.getElementById('lc_10000').value;

  await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(CFG)});
  alert('Saved. Use "Reload Program" for display/LED driver changes.');
}

async function detectSwitch(){
  const r = await fetch('/api/detect_switch',{method:'POST'});
  const hint = document.getElementById('sw_detect_hint');
  if(r.ok){
    const j = await r.json();
    hint.textContent = `Detected: ${j.model || 'unknown'} • Ports: ${j.ports ?? '-'} (saved)`;
    // re-pull config so port count/model are reflected here immediately
    await load();
    alert('Switch detected & saved.');
  }else{
    hint.textContent = 'Detect failed';
    alert('Detect failed');
  }
}

async function reloadSvc(){
  await fetch('/api/reload',{method:'POST'});
  alert('Restarting service…');
}

async function applyNet(){
  const mode = document.getElementById('net_mode').value;
  const body = { mode };
  if(mode==='static'){
    body.ip_cidr = document.getElementById('net_ip').value;
    body.gateway = document.getElementById('net_gw').value;
    body.dns = document.getElementById('net_dns').value;
  }
  const r = await fetch('/api/network',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(r.ok) alert('Network config applied. dhcpcd is restarting.');
  else alert('Failed to apply network.');
}

load();
</script>
</body>
</html>
