<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EtherPi</title>
  <style>
    :root { color-scheme: light dark;
      --bg:#0b0f14; --card:#111821; --text:#e6edf3; --muted:#9fb2c3; --line:#1f2a36; --btn:#182433;
    }
    body{font-family:system-ui,sans-serif;margin:20px;max-width:980px;background:var(--bg);color:var(--text)}
    .logo{font-weight:800;font-size:28px;letter-spacing:.5px;background:linear-gradient(90deg,#ff5f6d,#ffc371,#47cf73,#2ea8ff,#bd34fe);
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:var(--btn);color:var(--text);text-decoration:none;cursor:pointer}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px 16px;background:var(--card)}
    .muted{color:var(--muted)}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;color:var(--text)}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;border:1px solid #333;margin-right:6px;vertical-align:middle}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">EtherPi</div>
    <div style="display:flex;gap:8px">
      <a class="btn" href="/setup">Setup</a>
    </div>
  </div>
  <p class="muted">Colorize VLANs • Live Link/Speed LEDs • Sync across Pis • Optional mini display • Temps</p>

  <div class="cards">
    <div class="card">
      <h3>Device</h3>
      <div class="muted" id="model_hint"></div>
      <div>Switch: <span id="dev_host">-</span></div>
      <div>Switch Name: <span id="switch_name">-</span></div>
      <div>Ports: <span id="dev_ports">-</span></div>
      <div>SNMP: <span id="dev_snmp">-</span></div>
      <div>PoE: <span id="dev_poe">--</span></div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="identifyBtn" onclick="toggleIdentify()">Identify: ...</button>
      </div>
    </div>

    <div class="card">
      <h3>Sync</h3>
      <div>Mode: <span id="sync_mode">off</span></div>
      <div>Multicast: <span id="sync_mc">-</span></div>
      <div>Port: <span id="sync_port">-</span></div>
    </div>

    <div class="card">
      <h3>Temperatures</h3>
      <div>CPU: <span id="t_cpu">--</span> &deg;C</div>
      <div>EXT: <span id="t_ext">--</span> &deg;C</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Live Ports</h3>
    <table>
      <thead><tr><th>#</th><th>ifName</th><th>VLAN</th><th>Speed</th><th>Link</th><th>Test</th></tr></thead>
      <tbody id="state_rows"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>VLAN &rarr; Color</h3>
    <table>
      <thead><tr><th>VLAN</th><th>Color</th><th></th></tr></thead>
      <tbody id="vlan_rows"></tbody>
    </table>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <input id="new_vlan" type="number" placeholder="VLAN ID">
      <input id="new_color" type="color" value="#00ff00">
      <button class="btn" onclick="addVlan()">Add/Update</button>
      <button class="btn" onclick="saveConfig()">Save Config</button>
    </div>
  </div>

<script>
let CFG = null;

function vlanHex(v){
  if(!CFG) return "#101010";
  const map = CFG.vlan_colors || {};
  const key = (v == null ? "" : String(v));
  return map[key] || "#101010";
}
function linkHex(state){
  const lc = (CFG && CFG.link_colors) || {};
  if(!state || !state.up) return lc.down || "#000000";
  const m = parseInt(state.speed||0,10);
  if(m >= 10000) return lc["10000"] || "#2979FF";
  if(m >= 2500)  return lc["2500"]  || "#00FFFF";
  if(m >= 1000)  return lc["1000"]  || "#00C853";
  if(m >= 100)   return lc["100"]   || "#FFA500";
  if(m >= 10)    return lc["10"]    || "#A0A0A0";
  return lc.down || "#000000";
}
function speedText(s){
  if(!s) return "-";
  const m = parseInt(s,10);
  if(m >= 1000) return (m/1000) + " G";
  return m + " M";
}
function shortName(str){
  if(!str) return "-";
  let s = String(str);
  for(const cut of [" (", ",", " Build"]){
    const i = s.indexOf(cut);
    if(i > 0){ s = s.slice(0,i); break; }
  }
  s = s.trim();
  return (s.length > 36) ? (s.slice(0,33) + "...") : s;
}

async function refreshPoe(){
  try {
    const r = await fetch("/api/poe");
    if(!r.ok) throw new Error("no poe");
    const j = await r.json();
    const t = (j && j.total_w!=null) ? (j.budget_w!=null ? `${j.total_w.toFixed(1)} / ${j.budget_w.toFixed(0)} W` : `${j.total_w.toFixed(1)} W`) : "--";
    document.getElementById("dev_poe").textContent = t;
  } catch(e) { document.getElementById("dev_poe").textContent = "--"; }
}

async function loadConfig(){
  const r = await fetch('/api/config'); CFG = await r.json();

  document.getElementById('dev_host').textContent   = CFG.device?.switch_host ?? "-";
  document.getElementById('switch_name').textContent= shortName(CFG.device?.switch_name || CFG.device?.model_hint || "-");
  document.getElementById('dev_ports').textContent  = CFG.device?.ports?.count ?? "-";
  document.getElementById('dev_snmp').textContent   = (CFG.device?.snmp?.version || "v2c") + " / " + (CFG.device?.snmp?.community || "public");
  document.getElementById('sync_mode').textContent  = CFG.sync?.mode ?? "off";
  document.getElementById('sync_mc').textContent    = CFG.sync?.multicast ?? "-";
  document.getElementById('sync_port').textContent  = CFG.sync?.port ?? "-";
  document.getElementById('model_hint').textContent = CFG.device?.model_hint || "";

  await refreshTemps();
  await refreshState();
  await refreshIdentifyBtn();
  setInterval(refreshTemps, 3000);
  setInterval(refreshState, 1500);
  setInterval(refreshIdentifyBtn, 1500);
  setInterval(refreshPoe, 5000);
  refreshPoe();

  // VLAN table
  const t = document.getElementById('vlan_rows'); t.innerHTML = "";
  const entries = Object.entries(CFG.vlan_colors||{}).sort((a,b)=>parseInt(a[0]) - parseInt(b[0]));
  for(const [v,hx] of entries){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${v}</td><td><span class="dot" style="background:${hx}"></span> ${hx}</td>
                    <td><button class="btn" onclick="delVlan('${v}')">Delete</button></td>`;
    t.appendChild(tr);
  }
}

async function refreshTemps(){
  try{
    const r = await fetch('/api/temps'); const j = await r.json();
    const cpu = (j.cpu_c!=null)? j.cpu_c.toFixed(1) : '--';
    const extv = (j.ext_c ?? j.bmp280_c ?? j.bme280_c);
    const ext = (extv != null) ? (+extv).toFixed(1) : '--';
    document.getElementById('t_cpu').textContent = cpu;
    document.getElementById('t_ext').textContent = ext;
  }catch(e){}
}

// robust state renderer
async function refreshState(){
  const r = await fetch('/api/state'); const S = await r.json();
  const t = document.getElementById('state_rows'); t.innerHTML = "";
  const entries = Object.entries(S||{}).sort((a,b)=> (parseInt(a[0],10)||0) - (parseInt(b[0],10)||0));
  for(const [k, s] of entries){
    const p = parseInt(k,10) || k;
    const vlan = (s && s.vlan != null) ? s.vlan : '-';
    const vlanCell = `<span class="dot" style="background:${vlanHex(vlan)}"></span> ${vlan}`;
    const link = (s && s.up) ? "up" : "down";
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p}</td>
                    <td>${s?.ifName ?? '-'}</td>
                    <td>${vlanCell}</td>
                    <td>${speedText(s?.speed)}</td>
                    <td><span class="dot" style="background:${linkHex(s)}"></span> ${link}</td>
                    <td><button class="btn" onclick="blinkPort(${p})">Blink</button></td>`;
    t.appendChild(tr);
  }
}

async function detectSwitch(){
  const r = await fetch('/api/detect_switch',{method:'POST'});
  if(r.ok){ await loadConfig(); alert('Switch detected & port count updated.'); }
  else alert('Detect failed');
}

async function addVlan(){
  const id = document.getElementById('new_vlan').value;
  const hx = document.getElementById('new_color').value;
  if(!id) return;
  CFG.vlan_colors = CFG.vlan_colors || {};
  CFG.vlan_colors[String(parseInt(id,10))] = hx;
  await saveConfig(true);
  await loadConfig();
}
async function delVlan(v){
  if(!CFG.vlan_colors) return;
  delete CFG.vlan_colors[v];
  await saveConfig(true);
  await loadConfig();
}
async function saveConfig(skipAlert){
  await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(CFG)});
  if(!skipAlert) alert('Saved.');
}

async function refreshIdentifyBtn(){
  try{
    const r = await fetch('/api/identify'); const j = await r.json();
    document.getElementById('identifyBtn').textContent = 'Identify: ' + (j.on ? 'ON' : 'OFF');
  }catch(e){}
}
async function toggleIdentify(){
  const r = await fetch('/api/identify',{method:'POST'});
  if(r.ok) await refreshIdentifyBtn();
}
async function blinkPort(p){
  await fetch('/api/port_blink', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({port:p, seconds:3})});
}

(async function boot(){ await loadConfig(); })();
</script>
</body>
</html>
